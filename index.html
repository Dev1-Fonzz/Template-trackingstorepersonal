<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MFD Store - Live Tracker</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; }
    body { background: linear-gradient(135deg, #f9f7fe 0%, #e3f2fd 100%); min-height:100vh; padding:16px; }
    .container { max-width:800px; margin:0 auto; }
    header { text-align:center; margin-bottom:24px; padding:16px 0; }
    h1 { color:#2c3f50; font-size:2.2rem; }
    .tabs { display:flex; justify-content:center; gap:12px; margin-bottom:20px; }
    .tab-btn { padding:8px 20px; background:#e0e7ff; border:none; border-radius:30px; font-weight:600; color:#4f46e5; cursor:pointer; }
    .tab-btn.active { background:#4f46e5; color:white; }
    .panel { display:none; }
    .panel.active { display:block; animation:fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    .form-group { margin-bottom:16px; }
    label { display:block; margin-bottom:6px; font-weight:600; color:#374151; }
    input, textarea { width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:8px; font-size:16px; }
    button { background:#4f46e5; color:white; border:none; padding:12px; border-radius:8px; font-weight:600; cursor:pointer; width:100%; }
    button:hover { background:#4338ca; }
    .result-box { margin-top:16px; padding:12px; border-radius:8px; display:none; }
    .result-success { background:#dcfce7; color:#166534; }
    .result-error { background:#fee2e2; color:#991b1b; }
    .tracking-info { background:#f0f9ff; padding:16px; border-radius:10px; margin-top:16px; }
    .info-row { display:flex; justify-content:space-between; margin-bottom:8px; }
    .info-label { font-weight:600; color:#374151; }
    .info-value { color:#1e40af; }
    #map { height:350px; border-radius:10px; margin-top:20px; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üì¶ MFD Store Live Tracker</h1>
      <p>Sistem jejak pesanan kedai sendiri</p>
    </header>

    <div class="tabs">
      <button class="tab-btn active" onclick="showPanel('jejak')">üîç Jejak Pesanan</button>
      <button class="tab-btn" onclick="showPanel('tambah')">‚ûï Tambah Pesanan</button>
    </div>

    <!-- Jejak Panel -->
    <div id="jejak" class="panel active">
      <div class="form-group">        <label for="trackingInput">Tracking Number</label>
        <input type="text" id="trackingInput" placeholder="Contoh: MFD20260215001" />
      </div>
      <button onclick="jejakPesanan()">Cari Pesanan</button>
      <div id="jejakResult" class="result-box"></div>
      <div id="trackingInfo" class="tracking-info" style="display:none;"></div>
      <div id="map"></div>
    </div>

    <!-- Tambah Panel -->
    <div id="tambah" class="panel">
      <div class="form-group">
        <label>Tracking Number</label>
        <input type="text" id="newTracking" placeholder="Mesti unik" required />
      </div>
      <div class="form-group">
        <label>Status Pesanan</label>
        <input type="text" id="statusPesanan" placeholder="Contoh: Dalam Penghantaran" required />
      </div>
      <div class="form-group">
        <label>Nama Pembeli</label>
        <input type="text" id="namaPembeli" placeholder="Nama penuh" required />
      </div>
      <div class="form-group">
        <label>Nombor Telefon</label>
        <input type="tel" id="telefon" placeholder="0123456789" required />
      </div>
      <div class="form-group">
        <label>Jenis Pembayaran (Isi Manual)</label>
        <input type="text" id="jenisPembayaran" placeholder="Contoh: Tunai, Bank Islam" required />
      </div>
      <div class="form-group">
        <label>Pesanan</label>
        <textarea id="pesanan" rows="2" placeholder="Senarai item" required></textarea>
      </div>
      <div class="form-group">
        <label>Kuantiti</label>
        <input type="number" id="kuantiti" min="1" value="1" required />
      </div>
      <div class="form-group">
        <label>Jumlah Keseluruhan Harga (RM)</label>
        <input type="number" step="0.01" id="jumlahHarga" placeholder="25.50" required />
      </div>
      <div class="form-group">
        <label>Tarikh Pesanan Dibuat (YYYY-MM-DD)</label>
        <input type="date" id="tarikhDibuat" required />
      </div>
      <div class="form-group">
        <label>Tarikh Pesanan Selesai (YYYY-MM-DD)</label>
        <input type="date" id="tarikhSelesai" />      </div>
      <div class="form-group">
        <label>Lokasi Koordinat (Format: lat,lng;lat,lng)</label>
        <input type="text" id="lokasiKoordinat" placeholder="2.9265,101.6487;2.9300,101.6520" />
      </div>
      <div class="form-group">
        <label>History Note</label>
        <textarea id="historyNote" rows="2" placeholder="Catatan sejarah penghantaran"></textarea>
      </div>
      <button onclick="tambahPesanan()">Simpan ke Google Sheet</button>
      <div id="tambahResult" class="result-box"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // üîë GANTIKAN DENGAN WEB APP URL ANDA
    const SCRIPT_URL = "https://script.google.com/macros/s/YOUR_WEB_APP_URL/exec";

    function showPanel(id) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function showAlert(div, msg, ok) {
      div.textContent = msg;
      div.className = "result-box " + (ok ? "result-success" : "result-error");
      div.style.display = "block";
    }

    async function jejakPesanan() {
      const tracking = document.getElementById("trackingInput").value.trim();
      const resultDiv = document.getElementById("jejakResult");
      const infoDiv = document.getElementById("trackingInfo");
      const mapDiv = document.getElementById("map");

      if (!tracking) return showAlert(resultDiv, "Sila masukkan tracking number!", false);

      try {
        const res = await fetch(`${SCRIPT_URL}?tracking=${encodeURIComponent(tracking)}&t=${Date.now()}`);
        if (!res.ok) throw new Error("Sambungan gagal");
        
        const data = await res.json();
        if (!data.success) return showAlert(resultDiv, "‚ùå " + data.message, false);

        // Papar info
        infoDiv.innerHTML = `          <div class="info-row"><span class="info-label">Tracking Number:</span><span class="info-value">${data.trackingNumber}</span></div>
          <div class="info-row"><span class="info-label">Nama Pembeli:</span><span class="info-value">${data.namaPembeli}</span></div>
          <div class="info-row"><span class="info-label">Status:</span><span class="info-value">${data.statusPesanan}</span></div>
          <div class="info-row"><span class="info-label">Tarikh Dibuat:</span><span class="info-value">${data.tarikhDibuat || '-'}</span></div>
          <div class="info-row"><span class="info-label">Tarikh Selesai:</span><span class="info-value">${data.tarikhSelesai || '-'}</span></div>
          <div class="info-row"><span class="info-label">Jumlah Harga:</span><span class="info-value">RM ${parseFloat(data.jumlahHarga).toFixed(2)}</span></div>
          <div class="info-row"><span class="info-label">Jenis Bayaran:</span><span class="info-value">${data.jenisPembayaran}</span></div>
          <div class="info-row"><span class="info-label">History Note:</span><span class="info-value">${data.historyNote || '-'}</span></div>
        `;
        infoDiv.style.display = "block";
        showAlert(resultDiv, "‚úÖ Pesanan dijumpai!", true);

        // Render peta jika ada koordinat
        if (data.lokasiKoordinat) {
          renderMap(data.lokasiKoordinat, data.namaPembeli);
          mapDiv.style.display = "block";
        } else {
          mapDiv.style.display = "none";
        }
      } catch (err) {
        console.error(err);
        showAlert(resultDiv, "üö® Ralat: " + err.message, false);
        mapDiv.style.display = "none";
      }
    }

    function renderMap(coordString, namaPembeli) {
      const mapDiv = document.getElementById("map");
      mapDiv.innerHTML = "";

      const map = L.map('map').setView([2.9265, 101.6487], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      const points = coordString.split(';').map(pair => {
        const [lat, lng] = pair.split(',').map(Number);
        return [lat, lng];
      }).filter(p => !isNaN(p[0]) && !isNaN(p[1]));

      if (points.length === 0) return;

      // Tambah marker dengan nama pembeli pada setiap titik
      points.forEach((point, i) => {
        const popupText = i === 0 
          ? `${namaPembeli} (Mula)` 
          : `${namaPembeli} (Titik ${i+1})`;

        L.marker(point, {
          icon: L.divIcon({            className: 'custom-pin',
            html: `<div style="background:red;width:24px;height:24px;border-radius:50%;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);"></div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          })
        }).addTo(map).bindPopup(popupText);
      });

      // Lukis garis merah dari titik pertama ke terakhir
      if (points.length > 1) {
        L.polyline(points, { color: 'red', weight: 4, opacity: 0.8 }).addTo(map);
      }

      map.fitBounds(points);
    }

    async function tambahPesanan() {
      const fields = {
        trackingNumber: document.getElementById("newTracking").value.trim(),
        statusPesanan: document.getElementById("statusPesanan").value.trim(),
        namaPembeli: document.getElementById("namaPembeli").value.trim(),
        nomborTelefon: document.getElementById("telefon").value.trim(),
        jenisPembayaran: document.getElementById("jenisPembayaran").value.trim(),
        pesanan: document.getElementById("pesanan").value.trim(),
        kuantiti: document.getElementById("kuantiti").value,
        jumlahHarga: document.getElementById("jumlahHarga").value,
        tarikhDibuat: document.getElementById("tarikhDibuat").value,
        tarikhSelesai: document.getElementById("tarikhSelesai").value || "",
        lokasiKoordinat: document.getElementById("lokasiKoordinat").value.trim(),
        historyNote: document.getElementById("historyNote").value.trim()
      };

      const resultDiv = document.getElementById("tambahResult");
      if (Object.values(fields).slice(0,8).some(v => !v)) {
        return showAlert(resultDiv, "Sila isi medan wajib!", false);
      }

      try {
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(fields)
        });
        const data = await res.json();
        if (data.success) {
          showAlert(resultDiv, "‚úÖ " + data.message, true);
          document.querySelectorAll("#tambah input:not([type='date']), #tambah textarea").forEach(el => el.value = "");
          document.getElementById("tarikhDibuat").valueAsDate = new Date();
        } else {
          showAlert(resultDiv, "‚ùå " + data.message, false);        }
      } catch (err) {
        showAlert(resultDiv, "üö® Gagal simpan: " + err.message, false);
      }
    }

    // Set tarikh hari ini secara default
    window.onload = () => {
      document.getElementById("tarikhDibuat").valueAsDate = new Date();
    };
  </script>
</body>
</html>
